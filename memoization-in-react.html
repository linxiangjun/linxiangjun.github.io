<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Memoization技术在React中的应用"><meta name="keywords" content="React"><meta name="author" content="linxiangjun"><meta name="copyright" content="linxiangjun"><title>Memoization技术在React中的应用 | Code Charm</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#在Redux中的应用"><span class="toc-number">1.</span> <span class="toc-text">在Redux中的应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在React-Hook中的应用"><span class="toc-number">2.</span> <span class="toc-text">在React Hook中的应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">3.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/linxiangjun/ablum/master/blog-img/me.png"></div><div class="author-info__name text-center">linxiangjun</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/linxiangjun">Follow me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">8</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">3</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">3</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.ax1x.com/2019/09/05/nmpXAH.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Code Charm</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Memoization技术在React中的应用</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-09-26</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/React/">React</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>最近在研究React Hook优化时，发现<strong>Memoization</strong>技术被官方广泛的使用，比如<code>useCallback</code>和<code>useMemo</code>这两个API，分别用来返回函数的memoized版本和memoized值。<strong>Memoization</strong>其实并不是什么新技术，只是一种优化技巧，维基百科对<strong>Memoization</strong>的定义为：</p>
<blockquote>
<p>In computing, memoization or memoisation is an optimization technique used primarily to speed up computer programs by storing the results of expensive function calls and returning the cached result when the same inputs occur again.</p>
</blockquote>
<p>简单来说<strong>Memoization</strong>就是存储前一个值，然后每次更新时都将新传入的值和存储的值作比较，然后根据比较结果是否相同来返回存储的值还是新的值。React中使用该技术主要是为了避免不必要的重复渲染。</p>
<h2 id="在Redux中的应用"><a href="#在Redux中的应用" class="headerlink" title="在Redux中的应用"></a>在Redux中的应用</h2><p>我们用来优化Redux数据的<a href="https://github.com/reduxjs/reselect" target="_blank" rel="noopener">reselect</a>其实就使用了Memoization技术，这篇<a href="https://www.linxiangjun.com/2019/09/03/reselect-source-code/#createSelector">文章</a>分析了reselect源码，可以学习reselect是如果使用该技术来优化Redux数据的。</p>
<h2 id="在React-Hook中的应用"><a href="#在React-Hook中的应用" class="headerlink" title="在React Hook中的应用"></a>在React Hook中的应用</h2><p>熟悉了<strong>Memoization</strong>定义后，我们看下如果在实战中使用这个技术。在React Hook中，<code>useEffect</code>方法可以使用该技术来优化组件的渲染。本例子可以在<a href="https://codesandbox.io/s/useeffect-zkl36?fontsize=14" target="_blank" rel="noopener">CodeSandbox</a>中查看:smile:。</p>
<p>我们知道<code>useEffect</code>的第二个数组参数作为effect依赖存在，如果依赖数组发生改变，那么<code>useEffect</code>就会重新执行。<code>useEffect</code>使用<code>===</code>来比较数组参数是否相等，使用<code>Object.assign</code>或者<code>splice</code>这类会操作时会返回新的堆来存储引用值，就会导致值本身没有变化却会重复执行<code>useEffect</code>方法。为了避免这种情况的发生，我们来看下该如果来做。</p>
<p>首先，先来介绍下<code>useRef</code>方法，这个方法和原来的<code>createRef</code>非常的相似，都是创建一个可变的<code>ref</code>对象。在函数组件中，因为<code>ref</code>对象在组件的整个生命周期内保持不变，所以我们可以用它来存储不会被组件re-render影响的值。所以，在下面的函数中，我们使用<code>ref</code>对象来存储<code>useEffect</code>中传入的第二个数组参数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useRef &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; isEqual &#125; <span class="keyword">from</span> <span class="string">"lodash"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useDeepCompareMemoize</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = useRef();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isEqual(value, ref.current)) &#123;</span><br><span class="line">    ref.current = value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ref.current;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我使用了lodash中的深比较方法<code>isEqual</code>来对比两个值，这个可以根据需求自定义方法也可以。</p>
<p>接下来编写自定义Hook来使用<code>useEffect</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useDeepCompareEffect</span>(<span class="params">callback, dependencies</span>) </span>&#123;</span><br><span class="line">  useEffect(callback, useDeepCompareMemoize(dependencies));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useDeepCompareEffect;</span><br></pre></td></tr></table></figure>

<p>然后使用<code>useDeepCompareEffect</code>代替<code>useEffect</code>即可。</p>
<p>使用的完整代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect, useRef &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> useDeepCompareEffect <span class="keyword">from</span> <span class="string">"./useDeepCompareEffect.js"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"./styles.css"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tomCat = &#123;</span><br><span class="line">  name: <span class="string">"Tom"</span>,</span><br><span class="line">  race: <span class="string">"cat"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> jerryMouse = &#123;</span><br><span class="line">  name: <span class="string">"Jerry"</span>,</span><br><span class="line">  race: <span class="string">"mouse"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [character, updateCharacter] = useState(tomCat);</span><br><span class="line">  <span class="keyword">const</span> effectCount = useRef(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> deepCompareEffectCount = useRef(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    effectCount.current++;</span><br><span class="line">  &#125;, [character]);</span><br><span class="line"></span><br><span class="line">  useDeepCompareEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    deepCompareEffectCount.current++;</span><br><span class="line">  &#125;, [character]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> changeStar = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> star = character.name === <span class="string">"Tom"</span> ? jerryMouse : tomCat;</span><br><span class="line">    updateCharacter(star);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> assignObj = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    updateCharacter(<span class="built_in">Object</span>.assign(&#123;&#125;, character));</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;p&gt;Hello, useEffect&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;p className="star"&gt;</span></span><br><span class="line"><span class="regexp">        &#123;character.name&#125; &#123;character.race&#125; &#123;character.friend&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>p&gt;</span><br><span class="line">      &lt;p&gt;useEffect count = &#123;effectCount.current&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;p&gt;deepCompareEffectCount count = &#123;deepCompareEffectCount.current&#125;&lt;/</span>p&gt;</span><br><span class="line">      &lt;p&gt;</span><br><span class="line">        &lt;button onClick=&#123;changeStar&#125;&gt;Change star&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>p&gt;</span><br><span class="line">      &lt;p&gt;</span><br><span class="line">        &lt;button onClick=&#123;assignObj&#125;&gt;Click&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>p&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const rootElement = document.getElementById("root");</span></span><br><span class="line"><span class="regexp">ReactDOM.render(&lt;App /</span>&gt;, rootElement);</span><br></pre></td></tr></table></figure>

<p>同样的，点击Click按钮，使用<code>useEffect</code>方法每次都会执行，而使用<code>useDeepCompareEffect</code>的只会执行一次。不过需要注意的是，该优化并不是万金油，而是要根据情况来使用。因为深比较本来就会对性能造成一定的损耗，所以要按需使用。比如<code>useCallback</code>和<code>useMemo</code>最好在需要重复计算时才使用，在其他场景应用不当可能会有副作用，关于这一块的内容推荐阅读本文末尾中的参考文章。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://github.com/kentcdodds/use-deep-compare-effect" target="_blank" rel="noopener">use-deep-compare-effect</a></li>
<li><a href="https://github.com/alexreardon/memoize-one" target="_blank" rel="noopener">memoize-one</a></li>
<li><a href="https://blog.logrocket.com/rethinking-hooks-memoization/?from=singlemessage&isappinstalled=0" target="_blank" rel="noopener">You’re overusing useMemo: Rethinking Hooks memoization</a></li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">linxiangjun</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://www.linxiangjun.com/memoization-in-react.html">http://www.linxiangjun.com/memoization-in-react.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/React/">React</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/react-hooks-best-practices-1.html"><i class="fa fa-chevron-left">  </i><span>React Hooks技术最佳实践（一）</span></a></div><div class="next-post pull-right"><a href="/react-hook-acheieve-redux.html"><span>使用React Hook实现Redux状态机</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s2.ax1x.com/2019/09/05/nmpXAH.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2020 By linxiangjun</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>